function spikesort_rk(filenames, readNewUnits)
%function spikesort(filenames)
%function spikesort(filenames, readNewUnits)
%
% filenames is a cell array of strings. If no input is given, a dialog box
% will pop up to let you specify the file names graphically.
%
% readNewUnits is an optional flag. If any value is given (i.e., if nargin > 1) it
% reads the units from the ch*.mat files previously loaded. Only use this
% option if you're running spikesort a second time on the same file(s) that
% you just ran it on.
%
%
% LAST REVISION:
%
% 06Aug2013 - Added disclaimer text pop-up (MAS)
%

%
% 05Aug2013 - Fixed bug in keyboard shortcuts (ACS)
%
% 03Apr2013 - Added support for keyboard shortcuts (ACS)
%
% 06Nov2012 - Fixed a bug that caused an error if channels were active in
% some files but not others (around line 459) -Adam C. Snyder
%

clear global FileInfo Handles WaveformInfo colors test
global FileInfo Handles WaveformInfo colors test;

screenSize = get(0,'ScreenSize');
screenSize = screenSize(3:4); % the x and y
midX = floor(screenSize(1)/2);
midY = floor(screenSize(2)/2);

% a disclaimer figure will show up the first time spikesort is run
spikeSortPath = mfilename('fullpath');
[spikeSortPath,~,~] = fileparts(spikeSortPath);
disclaimerFile = [spikeSortPath,filesep,'runOnce.txt'];
if ~exist(disclaimerFile)
    d0 = figure('Color',[0.8 0.8 0.8], ...
        'MenuBar','none', ...
        'Name','SPIKESORT DISCLAIMER', ...
        'NumberTitle','off', ...
        'Tag','Temp1', ...
        'ToolBar','none', ...
        'Visible','on',...
        'Position', [midX-210 midY-140 420 280], ...
        'windowstyle','modal');
    % disclaimer text
    fid = fopen([spikeSortPath,filesep,'disclaimer.txt']);
    disclaimerText = textscan(fid,'%s','delimiter','\n');
    fclose(fid);
    uicontrol(d0,'Style','text', ...
        'HorizontalAlignment','left', ...
        'String',disclaimerText{1}, ...
        'Position',[10 50 400 220]);
    % if this button is clicked it creates the disclaimer file and doesn't
    % show this figure window again
    uicontrol(d0,'Style','pushbutton', ...
        'String','Don''t show this again', ...
        'Position',[145 10 130 30], ...
        'userdata',disclaimerFile, ...
        'callback',@acceptTermsCallback)
    % user must click the button or close the figure to continue
    uiwait(d0);
else
    % this means the disclaimer has already been accepted
end

%Adding support for running the function without input arguments, in which
%case the user is prompted to browse for datafiles to sort. -03Apr2013 Adam
%C. Snyder...
if nargin<1,
    [filenames,datapath] = uigetfile('*.nev','Select NEV files for sorting...','multiselect','on');
    if iscell(filenames),
        filenames = cellfun(@fullfile,repmat({datapath},size(filenames)),filenames,'uniformoutput',0);
    else
        filenames = fullfile(datapath,filenames);
    end;
end;
if ~iscell(filenames), filenames={filenames}; end; %handles the case if a single file name string is passed... -03Apr2013 Adam C. Snyder

colors = [
    [0 0 0] % black (sort code 0, unsorted)
    [1 0 0] % red (sort code 1)
    [0 0 1] % blue (etc)
    [0 1 0] % green (sort code 2)
    [1 0 1] % magenta
    [0 1 1] % cyan
    [1 0 .5] % pink
    [1 .5 0] % orange
    [1 1 0] % yellow
    [.5 0 .5] % purple
    [0 1 .5] % sea foam green
    [.5 .5 0] % bronze
    [0 .5 .5] % teal
    [.5 0 1] % light purple
    [0 .5 1] % light blue
    [.5 1 0] % chartreuse
    ];

colors(256,:) = [.7 .7 .7];

colors = 1 - colors;
for i = 1:size(colors,1)
    colors(i,:) = colors(i,:) ./ sqrt(sum(colors(i,:).^2));
end

colors(1,:) = colors(1,:)/2;

WaveformInfo.ChannelNumber = 0;

load('sac.mat');

j0 = figure('Color',[0.8 0.8 0.8], ...
    'Colormap',mat0, ...
    'MenuBar','none', ...
    'Name','Command History', ...
    'NumberTitle','off', ...
    'Position',[1 43 301 768], ...
    'Tag','Fig1', ...
    'ToolBar','none', ...
    'Visible','on');
Handles.historyFigure = j0;

Handles.history = uicontrol('Parent',j0, ...
    'BackgroundColor',[1 1 1], ...
    'Units','normalized', ...
    'Position',[.03 .75 .94 .2], ...
    'String','', ...
    'Style','listbox', ...
    'Callback','spikesort_gui_rk changeHistory', ...
    'Tag','History', ...
    'UserData',[], ...
    'Value',0);

Handles.ISINoise = axes('Parent',j0, ...
    'Units','pix', ...
    'Box','off', ...
    'CameraUpVector',[0 1 0], ...
    'CameraUpVectorMode','manual', ...
    'Clipping','off', ...
    'Color',[1 1 1], ...
    'NextPlot','add', ...
    'Units','normalized', ...
    'Position',[.1 .67 .8 .075], ...
    'Tag','isinoise', ...
    'UserData',1, ...
    'XColor',[0 0 0], ...
    'XLimMode','manual', ...
    'YColor',[0 0 0], ...
    'YLimMode','manual', ...
    'ZColor',[0 0 0], ...
    'ZLimMode','manual', ...
    'XTickLabel',[],...
    'TickDir','out');

Handles.ISI1 = axes('Parent',j0, ...
    'Units','pix', ...
    'Box','off', ...
    'CameraUpVector',[0 1 0], ...
    'CameraUpVectorMode','manual', ...
    'Clipping','off', ...
    'Color',[1 1 1], ...
    'NextPlot','add', ...
    'Units','normalized', ...
    'Position',[.1 .51 .8 .15], ...
    'Tag','isi1', ...
    'UserData',1, ...
    'XColor',[0 0 0], ...
    'XLimMode','manual', ...
    'YColor',[0 0 0], ...
    'YLimMode','manual', ...
    'ZColor',[0 0 0], ...
    'ZLimMode','manual', ...
    'XTickLabel',[],...
    'TickDir','out');

Handles.ISI2 = axes('Parent',j0, ...
    'Units','pix', ...
    'Box','off', ...
    'CameraUpVector',[0 1 0], ...
    'CameraUpVectorMode','manual', ...
    'Clipping','off', ...
    'Color',[1 1 1], ...
    'NextPlot','add', ...
    'Units','normalized', ...
    'Position',[.1 .35 .8 .15], ...
    'Tag','isi2', ...
    'UserData',1, ...
    'XColor',[0 0 0], ...
    'XLimMode','manual', ...
    'YColor',[0 0 0], ...
    'YLimMode','manual', ...
    'ZColor',[0 0 0], ...
    'XTickLabel',[],...
    'ZLimMode','manual', ...
    'TickDir','out');

Handles.ISI3 = axes('Parent',j0, ...
    'Units','pix', ...
    'Box','off', ...
    'CameraUpVector',[0 1 0], ...
    'CameraUpVectorMode','manual', ...
    'Clipping','off', ...
    'Color',[1 1 1], ...
    'NextPlot','add', ...
    'Units','normalized', ...
    'Position',[.1 .19 .8 .15], ...
    'Tag','isi3', ...
    'UserData',1, ...
    'XColor',[0 0 0], ...
    'XLimMode','manual', ...
    'YColor',[0 0 0], ...
    'YLimMode','manual', ...
    'ZColor',[0 0 0], ...
    'ZLimMode','manual', ...
    'XTickLabel',[],...
    'TickDir','out');

Handles.ISI4 = axes('Parent',j0, ...
    'Units','pix', ...
    'Box','off', ...
    'CameraUpVector',[0 1 0], ...
    'CameraUpVectorMode','manual', ...
    'Clipping','off', ...
    'Color',[1 1 1], ...
    'NextPlot','add', ...
    'Units','normalized', ...
    'Position',[.1 .03 .8 .15], ...
    'Tag','isi4', ...
    'UserData',1, ...
    'XColor',[0 0 0], ...
    'XLimMode','manual', ...
    'YColor',[0 0 0], ...
    'YLimMode','manual', ...
    'ZColor',[0 0 0], ...
    'ZLimMode','manual', ...
    'TickDir','out');

uicontrol('Parent',j0, ...
    'Callback','spikesort_gui_rk clear_history', ...
    'ListboxTop',0, ...
    'Units','normalized', ...
    'Position',[.25 .955 .5 .035], ...
    'String','Clear History', ...
    'Tag','Pushbutton52', ...
    'Value',1);

h0 = figure('Color',[0.8 0.8 0.8], ...
    'MenuBar','none', ...
    'Name','Spikesort', ...
    'NumberTitle','off', ...
    'Position',[310 43 1280 1024], ...
    'Tag','Fig1', ...
    'ToolBar','none',...
    'keypressfcn','spikesort_gui_rk keyfcn');

Handles.mainFigure = h0;

uicontrol('Parent',h0, ...
    'BackgroundColor',[.8 .8 .8], ...
    'ListboxTop',0, ...
    'Units','normalized', ...
    'Position',[.015 .97 .1 .020], ...
    'String','# Waveforms', ...
    'Style','text', ...
    'Tag','StaticText1');

Handles.blockSize = uicontrol('Parent',h0, ...
    'BackgroundColor',[1 1 1], ...
    'Units','normalized', ...
    'Position', [.015 .940 .1 .030], ...
    'String','100000', ...
    'Style','edit');

Handles.holdTheLine = uicontrol('Parent',h0, ...
    'BackgroundColor',[.8 .8 .8], ...
    'Units','normalized', ...
    'Position',[.015 .905 .015 .020 ], ...
    'String',mat7, ...
    'Callback','spikesort_gui_rk history',...
    'Style','checkbox', ...
    'Tag','HistoryEnable', ...
    'UserData','[ ]', ...
    'Value',1);

uicontrol('Parent',h0, ...
    'BackgroundColor',[.8 .8 .8], ...
    'ListboxTop',0, ...
    'Units','normalized', ...
    'Position',[.033 .905 .0847 .020], ...
    'String','Hold the Line', ...
    'Style','text', ...
    'HorizontalAlignment','Left',...
    'Tag','StaticText1');

uicontrol('Parent',h0, ...
    'BackgroundColor',[.8 .8 .8], ...
    'ListboxTop',0, ...
    'Units','normalized', ...
    'Position',[.015 .877 .03 .02], ...
    'String','max:', ...
    'Style','text', ...
    'HorizontalAlignment','Right',...
    'Tag','StaticText1');

Handles.maxMV = uicontrol('Parent',h0, ...
    'BackgroundColor',[1 1 1], ...
    'Units','normalized', ...
    'Position', [.045 .877 .07 .025], ...
    'String','', ...
    'Style','edit');

uicontrol('Parent',h0, ...
    'BackgroundColor',[.8 .8 .8], ...
    'ListboxTop',0, ...
    'Units','normalized', ...
    'Position',[.015 .845 .1 .020], ...
    'String','Channel #', ...
    'Style','text', ...
    'Tag','StaticText1');

Handles.channel = uicontrol('Parent',h0, ...
    'BackgroundColor',[1 1 1], ...
    'Units','normalized', ...
    'Position',[.015 .44 .1 .405], ...
    'String',mat7, ...
    'Style','listbox', ...
    'Tag','ChannelNo', ...
    'Callback','spikesort_gui_rk load', ...
    'UserData','[ ]', ...
    'Value',1);

uicontrol('Parent',h0, ...
    'Callback','spikesort_gui_rk sample', ...
    'ListboxTop',0, ...
    'Units','normalized', ...
    'Position',[.015 .40 .1 .035], ...
    'String','Resample Waves', ...
    'Tag','Pushbutton3', ...
    'Value',1);

uicontrol('Parent',h0, ...
    'Callback','spikesort_gui_rk threshold', ...
    'ListboxTop',0, ...
    'Units','normalized', ...
    'Position',[.015 .36 .1 .035], ...
    'String','Set Threshold', ...
    'Tag','Pushbutton6', ...
    'Value',1);

uicontrol('Parent',h0, ...
    'Callback','spikesort_gui_rk clear_threshold', ...
    'ListboxTop',0, ...
    'Units','normalized', ...
    'Position',[.015 .32 .1 .035], ...
    'String','Clear Thresholds', ...
    'Tag','Pushbutton5', ...
    'Value',1);


Handles.scalefactor = uicontrol('Parent',h0, ...
    'Style','Slider',...
    'Callback','spikesort_gui_rk set_scalefactor', ...
    'Units','normalized', ...
    'Position',[.015 .29 .1 .02], ...
    'Tag','slider1', ...
    'Min',1,'Max',10,'SliderStep',[0.01 .1],...
    'Value',10);

Handles.sortCodes = uicontrol('Parent',h0, ...
    'BackgroundColor',[1 1 1], ...
    'Units','normalized', ...
    'Position',[.015 .18 .1 .095], ...
    'String',mat7, ...
    'Style','listbox', ...
    'Tag','ChannelNo', ...
    'UserData','[ ]', ...
    'Value',1, ...
    'Max',2, ...
    'Callback', 'spikesort_gui_rk update');

uicontrol('Parent',h0, ...
    'Callback','spikesort_gui_rk moveSelected', ...
    'ListboxTop',0, ...
    'Units','normalized', ...
    'Position',[.015 .15 .1 .025], ...
    'String','Move to:', ...
    'Tag','Pushbutton1');

Handles.toMove = uicontrol('Parent',h0, ...
    'BackgroundColor',[1 1 1], ...
    'Units','normalized', ...
    'Position',[.015 .05 .1 .095], ...
    'String',mat7, ...
    'Style','listbox', ...
    'Tag','LineStyle', ...
    'UserData','[ ]', ...
    'Value',1);

uicontrol('Parent',h0, ...
    'Callback','spikesort_gui_rk write', ...
    'ListboxTop',0, ...
    'Units','normalized', ...
    'Position',[.015 .015 .1 .025], ...
    'String','Write All', ...
    'Tag','Pushbutton7', ...
    'Value',1);

Handles.plotHandle = axes('Parent',h0, ...
    'Units','normalized', ...
    'Box','on', ...
    'CameraUpVector',[0 1 0], ...
    'CameraUpVectorMode','manual', ...
    'Clipping','off', ...
    'Color',[1 1 1], ...
    'ColorOrder',mat1, ...
    'NextPlot','add', ...
    'Position',[.16 .2 .82 .78],...
    'Tag','waveforms', ...
    'UserData',1, ...
    'XColor',[0 0 0], ...
    'XLimMode','manual', ...
    'YColor',[0 0 0], ...
    'YLimMode','manual', ...
    'ZColor',[0 0 0], ...
    'ZLimMode','manual', ...
    'TickDir','out');

Handles.rasterHandle = axes('Parent',h0, ...
    'Units','normalized', ...
    'Box','off', ...
    'CameraUpVector',[0 1 0], ...
    'CameraUpVectorMode','manual', ...
    'Clipping','off', ...
    'Color',[1 1 1], ...
    'ColorOrder',mat1, ...
    'NextPlot','add', ...
    'Position',[.16 .05 .82 .115],...
    'Tag','raster', ...
    'UserData',1, ...
    'XColor',[0 0 0], ...
    'XLimMode','manual', ...
    'YColor',[0 0 0], ...
    'YLimMode','manual', ...
    'ZColor',[0 0 0], ...
    'ZLimMode','manual', ...
    'YTickLabel',[],...
    'TickDir','out');

%initialize FileInfo structure
FileInfo=struct('filename',[],'format','nev','HeaderSize',0,...
    'PacketSize',0,'ActiveChannels',[],'PacketOrder',uint8([]),...
    'SpikesNumber',[],'BytesPerSample',0,'bytes',[]);

warnflag = 0;
for i=1:length(filenames);
    FileInfo(i).filename=filenames{i} ;
    D = dir(filenames{i});
    assert(~isempty(D),'File %s not found',filenames{i});
    FileInfo(i).bytes = D.bytes;
    if (warnflag == 0)
        if (D.bytes >= 2^31) % File > 2 GB
            if (isempty(findstr(computer,'64'))) % Not using 64-bit matlab
                warning('DO NOT SORT FILES > 2 GB WITH 32-BIT MATLAB');
                warndlg('DO NOT SORT FILES > 2 GB WITH 32-BIT MATLAB');
            end
        end
        warnflag = 1;
    end
end

ActiveChannelList = [];

h = waitbar(0,'Reading files......');
for i = 1:length(FileInfo)
    spikesort_nevscan(i);
    ActiveChannelList = union(ActiveChannelList,FileInfo(i).ActiveChannels);
end
close(h);

WaveformInfo.NumSamples = FileInfo(1).NumSamples;
WaveformInfo.x2 = (FileInfo(1).NumSamples) * 1000 / FileInfo(1).TimeResolutionSamples;
WaveformInfo.x1 = -1000/FileInfo(1).TimeResolutionSamples;%(-round(FileInfo(1).NumSamples/5+1))*1000/FileInfo(1).TimeResolutionSamples;
%WaveformInfo.x2 = WaveformInfo.x2 + WaveformInfo.x1 + 2000/FileInfo(1).TimeResolutionSamples;

if length(unique([FileInfo(:).PacketSize]))~=1
    error('Variable Packet Sizes');
end

ChannelString = cell(length(ActiveChannelList),1);
for i=1:length(ActiveChannelList)
    i2=ActiveChannelList(i);
    
    totalSpikes = 0;
    for h = 1:length(FileInfo)
        if ismember(i2,FileInfo(h).ActiveChannels), %added this condition to avoid an error when one file has more channels than another... -21Mar2013 -Adam C. Snyder
            totalSpikes=totalSpikes + FileInfo(h).SpikesNumber(i2);
        end;
    end
    
    ChannelString{i} =  sprintf('%i (%i)',i2,totalSpikes);
    
    if exist(sprintf('spikesortunits/hist%i.mat',i2),'file') == 2
        load (sprintf('spikesortunits/hist%i',i2));
        
        if size(UserData,1) > 0
            ChannelString{i} = [ChannelString{i} ' *'];
        end
    end
end

set(Handles.channel,'String',ChannelString);
set(Handles.channel,'UserData',ActiveChannelList);
set(Handles.channel,'Value',1);

WaveformInfo.selected = [];

if ~exist('spikesortunits/','dir')
    mkdir spikesortunits
    if ~exist('spikesortunits/','dir')
        error('Unable to create "spikesortunits" directory');
    end
end

WaveformInfo.display = [];
WaveformInfo.rasterRes = 500;
WaveformInfo.historyValue = -1;

chan = ActiveChannelList; %Changed from 'FileInfo(1).ActiveChannels', which caused an error if a channel was not active in FileInfo(1), but was active in later files. -ACS 06Nov2012

if nargin < 2
    readSampleWaveforms(chan);
else
    h = waitbar(0,'Loading cached waveforms......');
    for i = 1:length(chan)
        waitbar(i/length(chan));
        
        load(sprintf('spikesortunits/ch%i.mat',i),'Unit');
        for j = 1:length(FileInfo)
            FileInfo(j).units{i} = zeros(256,1);
            FileInfo(j).units{i}(unique(double(Unit))+1) = 1;
        end
    end
    close(h);
end


function acceptTermsCallback(src,evt)

fid = fopen(get(src,'userdata'),'w+');
fprintf(fid,'%s','accepted');
fclose(fid);
delete(get(src,'parent'));

